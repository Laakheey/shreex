import{u as I,a as M,r as o,z as v,j as e,L as U,S as C,X as R,I as E,d as z,e as F}from"./index-DsMIEvEz.js";function $(){const{user:n}=I(),l=M(),[g,m]=o.useState([]),[x,N]=o.useState(!0),[p,b]=o.useState(!0),d=o.useRef(!0),h=40,f=o.useCallback(async s=>{if(!(!n||!l||!d.current))try{let r=l.from("support_messages").select("id, content, image_url, is_admin_reply, created_at").eq("user_id",n.id).order("created_at",{ascending:!1}).limit(h+1);s&&(r=r.lt("created_at",s));const{data:a,error:i}=await r;if(i){console.error("Supabase fetch error:",i),v.error("Failed to load chat history");return}if(!d.current)return;if(a&&a.length>0){const u=a.length>h,t=[...u?a.slice(0,h):a].reverse();m(c=>s?[...t,...c]:t),b(u)}else s||m([]),b(!1)}catch(r){console.error("Fetch error:",r)}finally{d.current&&N(!1)}},[n,l]);o.useEffect(()=>{if(d.current=!0,!n||!l)return;f();const s=l.channel(`support_chat:${n.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"support_messages",filter:`user_id=eq.${n.id}`},r=>{if(!d.current)return;const a=r.new;m(i=>i.some(u=>u.id===a.id)?i:[...i,a])}).subscribe();return()=>{d.current=!1,l.removeChannel(s)}},[n,l,f]);const y=o.useCallback(()=>{g.length>0&&p&&!x&&f(g[0].created_at)},[g,p,x,f]);return{messages:g,loading:x,hasMore:p,sendMessage:async(s,r)=>{if(!n||!l||!s.trim()&&!r)return;const a=`temp-${Date.now()}`,i={id:a,content:s.trim()||"",image_url:r||null,is_admin_reply:!1,created_at:new Date().toISOString()};m(t=>[...t,i]);const{data:u,error:j}=await l.from("support_messages").insert({user_id:n.id,content:s.trim()||null,image_url:r||null,is_admin_reply:!1}).select().single();if(j){console.error("Send error:",j),v.error("Failed to send message"),m(t=>t.filter(c=>c.id!==a));return}m(t=>t.map(c=>c.id===a?u:c))},uploadImage:async s=>{if(!n||!l)return null;try{const r=s.name.split(".").pop()?.toLowerCase()||"jpg",a=`${n.id}/support/${Date.now()}.${r}`,{error:i}=await l.storage.from("chat_attachments").upload(a,s,{contentType:s.type});if(i)throw i;const{data:u}=l.storage.from("chat_attachments").getPublicUrl(a);return v.success("Image uploaded!"),u.publicUrl}catch(r){return console.error("Upload error:",r),v.error("Upload failed"),null}},loadMore:y}}const D=()=>{const{messages:n,loading:l,hasMore:g,sendMessage:m,uploadImage:x,loadMore:N}=$(),[p,b]=o.useState(""),[d,h]=o.useState(!1),[f,y]=o.useState(null),[S,w]=o.useState(null),s=o.useRef(null),r=o.useRef(null),a=()=>{!r.current||!g||l||r.current.scrollTop===0&&N()};o.useEffect(()=>{s.current?.scrollIntoView({behavior:"smooth"})},[n.length]);const i=async t=>{if(t.preventDefault(),!p.trim()&&!f)return;let c="";if(f){h(!0);const _=await x(f);_&&(c=_),h(!1),y(null),w(null)}await m(p,c),b("")},u=t=>{const c=t.target.files?.[0];if(!c)return;y(c);const _=URL.createObjectURL(c);w(_)},j=()=>{y(null),w(null)};return l&&n.length===0?e.jsx(U,{}):e.jsxs("div",{className:"flex flex-col h-150 bg-white rounded-4xl shadow-sm border border-gray-100 overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b bg-gray-50/50 flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600",children:e.jsx(C,{size:20})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-900 text-sm",children:"Official Support"}),e.jsx("p",{className:"text-[10px] text-green-500 font-medium",children:"â— Online"})]})]}),e.jsxs("div",{ref:r,onScroll:a,className:"flex-1 overflow-y-auto p-6 space-y-4 scrollbar-hide",children:[g&&e.jsx("div",{className:"text-center py-2 text-[10px] text-gray-400 font-medium",children:"Scroll up to load older messages"}),n.map(t=>e.jsx("div",{className:`flex ${t.is_admin_reply?"justify-start":"justify-end"}`,children:e.jsxs("div",{className:`max-w-[80%] px-4 py-3 rounded-2xl text-sm ${t.is_admin_reply?"bg-gray-100 text-gray-800 rounded-tl-none":"bg-indigo-600 text-white rounded-tr-none"}`,children:[t.image_url&&e.jsx("a",{href:t.image_url,target:"_blank",rel:"noreferrer",children:e.jsx("img",{src:t.image_url,alt:"attachment",className:"rounded-lg mb-2 max-h-40 object-cover cursor-zoom-in"})}),e.jsx("p",{children:t.content})]})},t.id)),e.jsx("div",{ref:s})]}),e.jsxs("div",{className:"relative bg-gray-50 border-t p-4",children:[S&&e.jsxs("div",{className:"absolute -top-20 left-4 p-2 bg-white border border-gray-200 rounded-xl shadow-lg flex items-center gap-2 animate-in fade-in slide-in-from-bottom-2",children:[e.jsxs("div",{className:"relative w-12 h-12",children:[e.jsx("img",{src:S,alt:"Preview",className:"w-full h-full object-cover rounded-lg border border-gray-100"}),e.jsx("button",{onClick:j,className:"absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md hover:bg-red-600",children:e.jsx(R,{size:12})})]}),e.jsxs("div",{className:"pr-2",children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-900 truncate max-w-25",children:f?.name}),e.jsx("p",{className:"text-[8px] text-gray-400 uppercase",children:"Ready to send"})]})]}),e.jsxs("form",{onSubmit:i,className:"flex items-center gap-2",children:[e.jsx("input",{type:"file",id:"file-upload",className:"hidden",accept:"image/*",onChange:u,disabled:d}),e.jsx("label",{htmlFor:"file-upload",className:"w-10 h-10 flex items-center justify-center bg-white border border-gray-200 rounded-2xl text-gray-400 hover:text-indigo-600 cursor-pointer transition-colors",children:e.jsx(E,{size:18})}),e.jsx("input",{value:p,onChange:t=>b(t.target.value),placeholder:d?"Uploading image...":"Type your message...",disabled:d,className:"flex-1 bg-white border border-gray-200 rounded-2xl px-4 py-2 text-sm focus:outline-none disabled:opacity-50"}),e.jsx("button",{type:"submit",disabled:d,className:"w-10 h-10 bg-indigo-600 text-white rounded-2xl flex items-center justify-center hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-100",children:d?e.jsx(z,{size:18,className:"animate-spin"}):e.jsx(F,{size:18})})]})]})]})};export{D as default};
