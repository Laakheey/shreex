import{c as $,u as L,b as F,a as z,r as o,z as m,j as e,L as A,F as D,C as T,U as v}from"./index-CSVyV8r1.js";const I=[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]],S=$("dollar-sign",I),P="https://bull-rush-backend-production.up.railway.app";function U(){const{user:t}=L(),{getToken:f}=F(),s=z(),[y,g]=o.useState(""),[h,d]=o.useState(null),[u,p]=o.useState({one_time_total:0,ongoing_total:0,grand_total:0}),[N,c]=o.useState(!0),[r,n]=o.useState(!1),l=o.useRef(!0);return o.useEffect(()=>{l.current=!0;async function j(){if(!(!t||!s))try{c(!0);const{data:a,error:x}=await s.from("users").select("referrer_id, referral_code").eq("id",t.id).single();if(!l.current)return;if(x){console.error("Error fetching user data:",x),c(!1);return}g(a?.referral_code||t.id),a?.referrer_id&&n(!0);const{data:b,error:k}=await s.rpc("get_downline_tree_v2",{root_user_id:t.id});if(!l.current)return;k?console.error("Error fetching tree:",k):d(b||null);const{data:w,error:R}=await s.from("referral_bonuses").select("amount, bonus_type").eq("referrer_id",t.id);if(!l.current)return;if(R)console.error("Error fetching bonuses:",R);else if(w){const C=w.filter(i=>i.bonus_type==="first_investment").reduce((i,_)=>i+Number(_.amount),0),E=w.filter(i=>i.bonus_type==="ongoing").reduce((i,_)=>i+Number(_.amount),0);p({one_time_total:C,ongoing_total:E,grand_total:C+E})}}catch(a){console.error("Unexpected error in fetchData:",a)}finally{l.current&&c(!1)}}return j(),()=>{l.current=!1}},[t,s]),{myReferralCode:y,downline:h,bonuses:u,loading:N,applyReferralCode:async j=>{if(!t)return!1;try{const a=await f(),x=await fetch(`${P}/api/referral/apply`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({referralCode:j})}),b=await x.json();return x.ok?(m.success(b.message,{duration:4e3}),n(!0),window.location.reload(),!0):(m.error(b.error),!1)}catch(a){return console.error("Network error:",a),m.error("Network error. Please try again."),!1}},hasReferrer:r}}const B=()=>{const{myReferralCode:t,downline:f,bonuses:s,loading:y,applyReferralCode:g,hasReferrer:h}=U(),{user:d,isLoaded:u}=L(),p=`${window.location.origin}/?ref=${t}`;o.useEffect(()=>{(async()=>{if(u&&d&&!h){const n=localStorage.getItem("pending_referral_code");n&&await g(n)&&localStorage.removeItem("pending_referral_code")}})()},[d,u,h,g]);const N=()=>{navigator.clipboard.writeText(p).then(()=>m.success("Referral link copied!")).catch(()=>m.error("Failed to copy link"))};if(!u||y)return e.jsx(A,{});const c=r=>e.jsxs("li",{className:"ml-6",children:[e.jsxs("div",{className:"bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-100",children:[e.jsx("p",{className:"font-medium",children:r.display_name||`User...${r.id.slice(-5)}`}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Level ",r.level," â€¢ Active: $",Number(r.active_invested||0).toFixed(2)]})]}),r.children&&r.children.length>0&&e.jsx("ul",{className:"mt-2 border-l-2 border-indigo-200 pl-4",children:r.children.map(n=>c(n))})]},r.id);return e.jsxs(e.Fragment,{children:[e.jsx(D,{}),e.jsxs("div",{className:"max-w-4xl mx-auto p-8 space-y-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"Growth & Referrals"}),e.jsx("div",{className:"bg-linear-to-r from-indigo-600 to-purple-600 text-white p-8 rounded-3xl shadow-lg relative overflow-hidden",children:e.jsxs("div",{className:"relative z-10",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Invite & Earn Passive Income"}),e.jsxs("div",{className:"flex items-center gap-3 bg-white/10 p-2 rounded-2xl backdrop-blur-md border border-white/20",children:[e.jsx("code",{className:"flex-1 px-4 text-sm font-mono truncate",children:p}),e.jsx("button",{onClick:N,className:"p-3 bg-white text-indigo-600 rounded-xl hover:bg-indigo-50 transition-colors shadow-sm",children:e.jsx(T,{size:20})})]}),e.jsx("p",{className:"mt-4 text-sm text-indigo-100",children:"New users clicking your link will be automatically added to your network."})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-2xl border border-gray-100 shadow-sm text-center",children:[e.jsx(S,{className:"w-8 h-8 text-green-500 mx-auto mb-2"}),e.jsxs("p",{className:"text-2xl font-black text-gray-800",children:["$",s.one_time_total.toFixed(2)]}),e.jsx("p",{className:"text-xs text-gray-500 font-bold uppercase tracking-wider",children:"One-time Bonuses"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-2xl border border-gray-100 shadow-sm text-center",children:[e.jsx(v,{className:"w-8 h-8 text-blue-500 mx-auto mb-2"}),e.jsxs("p",{className:"text-2xl font-black text-gray-800",children:["$",s.ongoing_total.toFixed(2)]}),e.jsx("p",{className:"text-xs text-gray-500 font-bold uppercase tracking-wider",children:"Ongoing Passive"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-2xl border border-gray-100 shadow-sm text-center",children:[e.jsx("div",{className:"w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2",children:e.jsx(S,{className:"w-5 h-5 text-purple-600"})}),e.jsxs("p",{className:"text-2xl font-black text-gray-800",children:["$",s.grand_total.toFixed(2)]}),e.jsx("p",{className:"text-xs text-gray-500 font-bold uppercase tracking-wider",children:"Total Earnings"})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-8 shadow-sm",children:[e.jsxs("h2",{className:"text-xl font-bold mb-8 flex items-center gap-3 text-gray-800",children:[e.jsx(v,{size:24,className:"text-indigo-600"}),"Your Referral Network"]}),f?.children?.length?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("ul",{className:"space-y-6",children:[e.jsxs("li",{className:"font-bold text-center bg-gray-50 py-4 rounded-2xl border border-dashed border-gray-200 mb-8",children:[e.jsx("p",{className:"text-gray-400 text-xs uppercase mb-1",children:"Root Account"}),d?.firstName||"You"]}),f.children.map(r=>c(r))]})}):e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(v,{size:32,className:"text-gray-300"})}),e.jsx("p",{className:"text-gray-500 font-medium",children:"No direct referrals yet"}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Share your link to start earning commissions."})]})]})]})]})};export{B as default};
